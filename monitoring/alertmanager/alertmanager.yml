global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alertmanager@studycicd.local'

# ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë¼ìš°íŒ… ì „ëµ (ìš°ì„ ìˆœìœ„ ê¸°ë°˜)
route:
  group_by: ['alertname', 'service']
  group_wait: 10s
  group_interval: 30s
  repeat_interval: 12h
  receiver: 'default-webhook'
  
  routes:
  # ìë™ ë¡¤ë°± íŠ¸ë¦¬ê±° (ìµœê³  ìš°ì„ ìˆœìœ„)
  - match:
      action: auto-rollback
    receiver: 'auto-rollback-webhook'
    group_wait: 0s  # ì¦‰ì‹œ ì‹¤í–‰
    group_interval: 5s
    repeat_interval: 1h
    continue: false  # ë‹¤ë¥¸ ë¼ìš°íŠ¸ ì „íŒŒ ì°¨ë‹¨
    
  # ì¹´ë‚˜ë¦¬ ë°°í¬ ì¼ë°˜ í¬ë¦¬í‹°ì»¬ ì•ŒëŒ
  - match:
      severity: critical
      service: canary-deployment
    receiver: 'canary-critical'
    group_wait: 5s
    group_interval: 1m
    repeat_interval: 30m
    
  # ì¼ë°˜ ê²½ê³ 
  - match:
      severity: warning
    receiver: 'general-alerts'
    group_wait: 2m
    group_interval: 5m
    repeat_interval: 6h

receivers:
# ìë™ ë¡¤ë°± ì „ìš© ì›¹í›… (ì‹¤ë¬´ í•µì‹¬)
- name: 'auto-rollback-webhook'
  webhook_configs:
  - url: 'http://nginx-lb/webhook/auto-rollback'
    send_resolved: false
    http_config:
      basic_auth:
        username: 'rollback-system'
        password: 'auto-rollback-secret-key-2024'

# ì¹´ë‚˜ë¦¬ í¬ë¦¬í‹°ì»¬ ì•ŒëŒ (íŒ€ í†µë³´ìš©)
- name: 'canary-critical'
  webhook_configs:
  - url: 'http://nginx-lb/webhook/critical'
    send_resolved: true
  # Slack ì—°ë™ (ì‹¤ì œ í™˜ê²½ì—ì„œ í™œìš©)
  slack_configs:
  - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
    channel: '#deployment-alerts'
    username: 'AlertManager'
    color: 'danger'
    title: 'ğŸš¨ ì¹´ë‚˜ë¦¬ ë°°í¬ í¬ë¦¬í‹°ì»¬ ì•ŒëŒ'
    text: |
      {{ range .Alerts }}
      *{{ .Annotations.summary }}*
      {{ .Annotations.description }}
      ì„œë¹„ìŠ¤: {{ .Labels.service }}
      ì‹œì‘ì‹œê°„: {{ .StartsAt.Format "15:04:05" }}
      {{ end }}

# ì¼ë°˜ ì•ŒëŒ
- name: 'general-alerts'
  webhook_configs:
  - url: 'http://nginx-lb/webhook/general'
    send_resolved: true

# ê¸°ë³¸ ì›¹í›…
- name: 'default-webhook'
  webhook_configs:
  - url: 'http://nginx-lb/webhook/default'
    send_resolved: true

# ì‹¤ë¬´ì—ì„œ ì¤‘ìš”í•œ ì–µì œ ê·œì¹™
inhibit_rules:
# ìë™ ë¡¤ë°±ì´ íŠ¸ë¦¬ê±°ë˜ë©´ ë‹¤ë¥¸ ëª¨ë“  ì•ŒëŒ ì–µì œ
- source_match:
    action: 'auto-rollback'
  target_match_re:
    alertname: '.+'
  equal: ['service']